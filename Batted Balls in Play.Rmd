---
title: "Batted Balls in Play"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
require(dplyr)
require(stringr)
require(rpart)
require(corrplot)
require(ggplot2)
library(dplyr)
library(stringr)
library(rpart)
library(corrplot)
library(ggplot2)
```

```{r}
url <- "https://raw.githubusercontent.com/Chrisboatto/Batted-Balls-In-Play/main/Pitching%20Stats.csv"
```

```{r}
pitchingStats <- read.csv(url)
```

```{r}
str(pitchingStats)
```

```{r}
summary(pitchingStats)
```

```{r}
sum(is.na(pitchingStats))
```

```{r}
pitchingStats <- pitchingStats %>% filter(!is.na(vFA..pi.)) %>% filter(IP > 100) %>% select(-c(Dollars, playerid)) %>% mutate(BinaryPitching = case_when(ERA < 4.30 ~ 1, ERA > 4.29 ~ 0))
```

```{r}
pitchingStats$LOB. <- as.numeric(sub("%", "", pitchingStats$LOB.))/100
pitchingStats$GB. <- as.numeric(sub("%", "", pitchingStats$GB.))/100
pitchingStats$HR.FB <- as.numeric(sub("%", "", pitchingStats$HR.FB))/100
pitchingStats <- rename(pitchingStats, Name = Ã¯..Name)
```

```{r}
sum(is.na(pitchingStats))
```

```{r}
pitchingStatsCor <- cor(pitchingStats[17:39])
corrplot(pitchingStatsCor, type = "upper", order = 'hclust', tl.col = 'red')
```

```{r}
ggplot(pitchingStats) + 
  geom_density(aes(x = FB, fill = "FB", alpha = 0.8)) +
  geom_density(aes(x = SO, fill = "SO", alpha = 0.8)) +
  geom_density(aes(x = LD, fill = "LD", alpha = 0.8)) +
  geom_density(aes(x = GB, fill = "GB", alpha = 0.8)) +
  labs(title = "Batted Ball Density Plot", subtitle = "2019 Season", x = "Batted Ball", y = "Density") +
  theme(panel.background = element_blank(), axis.line =  element_line(color = "black"))
```

```{r}
ggplot(pitchingStats) +
  geom_point(aes(x = SO, y = ERA, colour = 'Strikeout'), size = 1) + 
  geom_point(aes(x = GB, y = ERA, colour = 'Ground ball'), size = 1) + 
  geom_point(aes(x = LD, y = ERA, colour = 'Line Drive'), size = 1) +
  geom_point(aes(x = FB, y = ERA, colour = 'Fly Ball'), size = 1) +
  geom_smooth(aes(x = SO, y = ERA), method = "auto", level = 0.9, colour = "purple") + 
  geom_smooth(aes(x = GB, y = ERA), method = "auto", level = 0.9, colour = "green") + 
  geom_smooth(aes(x = LD, y = ERA), method = "auto", level = 0.9, colour = "royal blue") +
  geom_smooth(aes(x = FB, y = ERA), method = "auto", level = 0.9, colour = "red") +
  labs(title = "Batted Balls to ERA Correlation", subtitle = "2019 MLB Season (100ip min)", x = "Number of Batted Balls", y = "ERA", colour = "Batted Balls")
  
  
```

```{r}
set.seed(118916)
train <- sample(nrow(pitchingStats), 0.80*nrow(pitchingStats), replace = FALSE)
train_set <- pitchingStats[train,]
test_set <- pitchingStats[-train,]
```

```{r}
model <- rpart(BinaryPitching ~ ., data = train_set, method = 'class')
```

```{r}
baseImp <- varImp(model)
baseImp
```

```{r}
baseImp <- as.data.frame(baseImp)
ggplot(baseImp, aes(Overall, row.names(baseImp))) + 
  geom_bar(stat = "identity", width = 0.1, fill = "black") + 
  geom_point(shape = 21, size = 3, colour = "black", fill = "green", stroke = 2) + 
  labs(title = "ERA Importance", x = "Importance", y = "Variable")
```

```{r}
newModel <- rpart(BinaryPitching ~ SO + FB + GB + LD + H + HR + BB + Strikes + BU + BUH, data = train_set, method = 'class')
```

```{r}
ERA_train <- predict(newModel, train_set, type = 'vector')
ERA_test <- predict(newModel, test_set, type = "vector")
```

```{r}
train_set <- cbind(train_set, ERA_train)
test_set <- cbind(test_set, ERA_test)
```

```{r}
names(train_set)[names(train_set) == "ERA_train"] <- "PitchPred"
names(test_set)[names(test_set) == "ERA_test"] <- "PitchPred"
```

```{r}
PitchFull <- rbind(train_set, test_set)
```

```{r}
newImp <- varImp(newModel)
newImp

newImp <- as.data.frame(newImp)
ggplot(newImp, aes(Overall, row.names(newImp))) + 
  geom_bar(stat = "identity", width = 0.1, fill = "black") + 
  geom_point(shape = 21, size = 3, colour = "black", fill = "green", stroke = 2) + 
  labs(title = "ERA Importance", x = "Importance", y = "Variable")
```

```{r}
roc_test <- roc(ifelse(test_set$BinaryPitching == "1", "1", "0"), as.numeric(test_set$PitchPred))
roc_train <- roc(ifelse(train_set$BinaryPitching == "1", "1", "0"), as.numeric(train_set$PitchPred))
plot(roc_test, col = "blue", main = "Pitching ROC Graph")
lines(roc_train, col = "green")
```


```{r}
ERA_Full_1 <- ERA_Full %>% mutate(ERA_Diff = ERA - ERAPred) %>% select(c(Name, BinaryPitching, ERA, ERAPred, ERA_Diff, SO, GB, FB, LD, BB, H, HR))
```

```{r}
ERA_Full_1[order(ERA_Full_1$ERA_Diff),]
```

